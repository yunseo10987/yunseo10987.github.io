---
title: "[2025-07-08] File Vulnerability"
excerpt: "File Vulnerability 정리"

categories:
  - Justice
tags:
  - [File, Upload, Download]

permalink: /Justice/[2025-07-08] File Vulnerability/

toc: true
toc_sticky: true

date: 2025-07-08
last_modified_at: 2025-07-15
---

## 🦥 본문

### 정의

파일을 업로드, 다운로드, 읽기, 삭제, 경로 접근 등의 기능을 제공할 때 발생하는 취약점. 

### 종류

- File Upload Vulnerablility :  파일 업로드 시 발생하는 취약점.
- File Download Vulnerablilty : 파일 다운로드 시 발생하는 취약점.

## File Upload Vulnerability

### 정의

파일 업로드 시 발생하는 취약점. 이용자가 파일의 이름을 임의로 정할 수 있을 때 발생. 악성 스크립트나 WebShell을 업로드하여 원격 코드를 실행하여 발생한다.

### 웹 쉘

공격자가 웹 서버에 업로드하여 사용하는 원격 명령 실행 도구. 웹을 통해 명령어를 실행할 수 있는 쉘(터미널) 형태의 악성 스크립트.  

- CGI : 웹 서버와 외부 프로그램 사이에서 인터페이스를 제공하는 프로토콜. 웹 서버는 HTML 같은 정적인 파일만 제공할 수 있지만 CGI를 통해 동적으로 실행되는 프로그램 결과도 제공할 수 있다. 웹 서버는 CGI를 통해 파일을 실행하고 사용자에게 반환한다.
    - 동작 흐름
        1. 사용자가 브라우저에서 요청
            
            ```python
            cgi-bin/script.py?name=yunseo
            ```
            
        2. 웹 서버가 CGI 프로그램(script.py)을 실행
        3. 요청 데이터(name=yunseo)를 CGI 프로그램에 전달
        4. CGI 프로그램이 동작 후 HTML 형식의 결과를 출력
        5. 웹 서버가 그 결과를 클라이언트에게 응답

### 종류

- Path Traversal : 임의 디렉터리에 접근하여 파일을 업로드할 수 있는 취약점.
    - EX) 실행되고 있는 app.py와 같은 디렉토리에 파일을 업로드하여 app.py를 덮어 씌운다. 서버가 재실행될때 악성 스크립트를 실행할 수 있다.
- 악성 파일 업로드 : 파일을 제대로 검사하지 않아서 발생하는 취약점.
    - EX) 프로필 사진 업로드 기능을 사용하는 페이지에 서버는 확장자를 .jpg .png등으로 필터링을 하는 경우에 shell.php.jpg 처럼 확장자만 위장한 Webshell 파일을 업로드하고 해당 파일에 접근할 때 발생한다. 또는 html 파일에 악의적인 스크립트를 삽입하면 XSS 공격으로도 이어질 수 있다.

### 대응 방법

- 파일 확장자나 MIME 타입을 모두 서버 측에서 대조 및 검사하여 단순 확장자 변환을 막을 수 있음
- Magic Number를 통해 파일 내용 검증하여 확장자나 MIME이 정상이어도 내부의 악성코드를 발견하여 검사할 수 있음
- 실행 권한 없는 디렉터리에 저장하여 업로드된 파일을 직접 실행하지 못하게 함
- 업로드 파일명을 랜덤한 이름으로 재설정하여 경로 예측을 막음

## File Download Vulnerability

### 정의

파일 다운로드 시 발생하는 취약점. 이용자가 다운로드할 파일의 이름을 임의로 정할 수 있을 때 발생. 

### 동작 흐름

![image.png](https://yunseo10987.github.io/assets/images/posts_img/2025-07-08%20File/image.png)

1. 사용자가 특정 파일을 요청
2. 서버는 BASE_DIR을 기준으로 해당 파일을 찾아 전송
3. 공격자가 ../../../ 등을 이용하여 민감한 파일을 요청
4. 상대 경로를 필터링하지 않는 경우 민감한 파일의 정보가 노출

### 대응 방법

- 사용자가 입력한 파일명을 바로 다운로드하지 않고 ID 기반으로 매핑 후 다운
- 상대 경로/절대 경로 정규화 및 필터링을 통해 기준 디렉토리를 벗어나는 것을 막음
- 다운로드 대상 파일을 화이트리스트로 제한하여 임의의 파일 접근을 막음
- 다운로드 시 세션, 토큰을 통한 인증 및 권한 확인
- Content-Disposition을 설정하여 브라우저가 파일을 바로 실행하거나 렌더링하지 않고 무조건 다운로드하도록 강제
    - 설정하지 않으면 서버에서 특정 파일을 그냥 보내버리면 웹페이지처럼 랜더링을 하기 때문에 악성 코드가 실행된다.