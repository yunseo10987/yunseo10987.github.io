---
title: "[2025-07-11] CSRF-1, CSRF-2"
excerpt: "CSRF-1, CSRF-2"

categories:
  - Problem
tags:
  - [XSS]

permalink: /Problem/[2025-07-11] CSRF-1, CSRF-2/

toc: true
toc_sticky: true

date: 2025-07-11
last_modified_at: 2025-07-11
---

## ğŸ¦¥ ë³¸ë¬¸

## CSRF-1

```c
from flask import Flask, request, render_template
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
import urllib
import os

app = Flask(__name__)
app.secret_key = os.urandom(32)

try:
    FLAG = open("./flag.txt", "r").read()
except:
    FLAG = "[**FLAG**]"

def read_url(url, cookie={"name": "name", "value": "value"}):
    cookie.update({"domain": "127.0.0.1"})
    try:
        service = Service(executable_path="/chromedriver")
        options = webdriver.ChromeOptions()
        for _ in [
            "headless",
            "window-size=1920x1080",
            "disable-gpu",
            "no-sandbox",
            "disable-dev-shm-usage",
        ]:
            options.add_argument(_)
        driver = webdriver.Chrome(service=service, options=options)
        driver.implicitly_wait(3)
        driver.set_page_load_timeout(3)
        driver.get("http://127.0.0.1:8000/")
        driver.add_cookie(cookie)
        driver.get(url)
    except Exception as e:
        driver.quit()
        print(str(e))
        # return str(e)
        return False
    driver.quit()
    return True

def check_csrf(param, cookie={"name": "name", "value": "value"}):
    url = f"http://127.0.0.1:8000/vuln?param={urllib.parse.quote(param)}"
    return read_url(url, cookie)

@app.route("/")
def index():
    return render_template("index.html")

@app.route("/vuln")
def vuln():
    param = request.args.get("param", "").lower()
    xss_filter = ["frame", "script", "on"]
    for _ in xss_filter:
        param = param.replace(_, "*")
    return param

@app.route("/flag", methods=["GET", "POST"])
def flag():
    if request.method == "GET":
        return render_template("flag.html")
    elif request.method == "POST":
        param = request.form.get("param", "")
        if not check_csrf(param):
            return '<script>alert("wrong??");history.go(-1);</script>'

        return '<script>alert("good");history.go(-1);</script>'

memo_text = ""

@app.route("/memo")
def memo():
    global memo_text
    text = request.args.get("memo", None)
    if text:
        memo_text += text
    return render_template("memo.html", memo=memo_text)

@app.route("/admin/notice_flag")
def admin_notice_flag():
    global memo_text
    if request.remote_addr != "127.0.0.1":
        return "Access Denied"
    if request.args.get("userid", "") != "admin":
        return "Access Denied 2"
    memo_text += f"[Notice] flag is {FLAG}\n"
    return "Ok"

app.run(host="0.0.0.0", port=8000)
```

- ì½”ë“œë¥¼ ë³´ë©´ ì¼ë‹¨ FLAGëŠ” admin/notice_flagì—ì„œ ì–»ì–´ì•¼ ê²ƒì„ ì•Œ ìˆ˜ ìˆëŠ” ë° ì–»ê¸° ìœ„í•´ì„œëŠ” ipì£¼ì†Œê°€ 127.0.0.1ì— useridê°€ adminì´ì–´ì•¼ í•œë‹¤.
- read_urlì´ ë¬´ìŠ¨ ì˜ë¯¸ì¸ ì§€ ëª°ë¼ì„œ ì°¾ì•„ ë´¤ëŠ”ë° ì›¹ë“œë¼ì´ë²„ë¥¼ ì´ìš©í•´ì„œ URLì„ ìš”ì²­í•˜ëŠ” ì½”ë“œì˜€ë‹¤. ì¦‰, ì´ í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ë©´ 127.0.0.1ë¡œ ì ‘ì†í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.
- read_urlì„ ì´ìš©í•˜ê¸° ìœ„í•´ì„œ check_csrfë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ê³  check_csrfë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ flag ë©”ì†Œë“œë¥¼ Post ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼í•´ì•¼ í•œë‹¤. ì´ ë•Œ paramì„ í†µí•´ userIdë§Œ í•´ê²°í•˜ë©´ ë©”ëª¨ì— FLAGê°€ ì‚½ì…ë˜ì–´ FLAGë¥¼ ì•Œ ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.
- ì´ ë•Œ on, frame, scriptëŠ” í•„í„°ë§ ë˜ë¯€ë¡œ ì•„ë˜ë¥¼ ì‚¬ìš©í–ˆë‹¤.

```
<img src=/admin/notice_flag?userid=admin>
```

ë§ˆì¹¨ flag í˜ì´ì§€ëŠ” post ë°©ì‹ìœ¼ë¡œ ì œì¶œí•  ìˆ˜ ìˆëŠ” í˜ì´ì§€ë¼ì„œ

![image.png](https://yunseo10987.github.io/assets/images/posts_img/2025-07-11%20CSRF12/image-3.png)

ìœ„ì˜ ì½”ë“œë¥¼ ì œì¶œí•˜ê³  ë©”ëª¨ í˜ì´ì§€ì— ë“¤ì–´ê°€ë‹ˆê¹

![image.png](https://yunseo10987.github.io/assets/images/posts_img/2025-07-11%20CSRF12/image-4.png)

## 2. CSRF-2

```c
#!/usr/bin/python3
from flask import Flask, request, render_template, make_response, redirect, url_for
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
import urllib
import os

app = Flask(__name__)
app.secret_key = os.urandom(32)

try:
    FLAG = open("./flag.txt", "r").read()
except:
    FLAG = "[**FLAG**]"

users = {
    'guest': 'guest',
    'admin': FLAG
}

session_storage = {}

def read_url(url, cookie={"name": "name", "value": "value"}):
    cookie.update({"domain": "127.0.0.1"})
    try:
        service = Service(executable_path="/chromedriver")
        options = webdriver.ChromeOptions()
        for _ in [
            "headless",
            "window-size=1920x1080",
            "disable-gpu",
            "no-sandbox",
            "disable-dev-shm-usage",
        ]:
            options.add_argument(_)
        driver = webdriver.Chrome(service=service, options=options)
        driver.implicitly_wait(3)
        driver.set_page_load_timeout(3)
        driver.get("http://127.0.0.1:8000/")
        driver.add_cookie(cookie)
        driver.get(url)
    except Exception as e:
        driver.quit()
        print(str(e))
        # return str(e)
        return False
    driver.quit()
    return True

def check_csrf(param, cookie={"name": "name", "value": "value"}):
    url = f"http://127.0.0.1:8000/vuln?param={urllib.parse.quote(param)}"
    return read_url(url, cookie)

@app.route("/")
def index():
    session_id = request.cookies.get('sessionid', None)
    try:
        username = session_storage[session_id]
    except KeyError:
        return render_template('index.html', text='please login')

    return render_template('index.html', text=f'Hello {username}, {"flag is " + FLAG if username == "admin" else "you are not an admin"}')

@app.route("/vuln")
def vuln():
    param = request.args.get("param", "").lower()
    xss_filter = ["frame", "script", "on"]
    for _ in xss_filter:
        param = param.replace(_, "*")
    return param

@app.route("/flag", methods=["GET", "POST"])
def flag():
    if request.method == "GET":
        return render_template("flag.html")
    elif request.method == "POST":
        param = request.form.get("param", "")
        session_id = os.urandom(16).hex()
        session_storage[session_id] = 'admin'
        if not check_csrf(param, {"name":"sessionid", "value": session_id}):
            return '<script>alert("wrong??");history.go(-1);</script>'

        return '<script>alert("good");history.go(-1);</script>'

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'GET':
        return render_template('login.html')
    elif request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        try:
            pw = users[username]
        except:
            return '<script>alert("not found user");history.go(-1);</script>'
        if pw == password:
            resp = make_response(redirect(url_for('index')) )
            session_id = os.urandom(8).hex()
            session_storage[session_id] = username
            resp.set_cookie('sessionid', session_id)
            return resp 
        return '<script>alert("wrong password");history.go(-1);</script>'

@app.route("/change_password")
def change_password():
    pw = request.args.get("pw", "")
    session_id = request.cookies.get('sessionid', None)
    try:
        username = session_storage[session_id]
    except KeyError:
        return render_template('index.html', text='please login')

    users[username] = pw
    return 'Done'

app.run(host="0.0.0.0", port=8000)
```

- ê¸°ì¡´ì˜ í’€ì—ˆë˜ CSRF-2 ë¬¸ì œì™€ ë¹„ìŠ·í•˜ë‹¤. ëª©í‘œëŠ” adminì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì„œ adminìœ¼ë¡œ ë¡œê·¸ì¸í•´ì„œ Flagë¥¼ ë³´ëŠ” ê²ƒì´ë‹¤.
- login API
    
    ë¡œê·¸ì¸ ì‹œ ëœë¤ ìƒì„± â†’ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— { ëœë¤ : ì•„ì´ë””} ì €ì¥ â†’ ì¿ í‚¤ {ì•„ì´ë”” : ëœë¤ }
    
- flag API
    
    paramì„ ë°›ì•„ì˜´ â†’ ëœë¤ ìˆ«ì ìƒì„± â†’ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— {ëœë¤ : admin } ì €ì¥ â†’ check_csrfì— paramê³¼ ëœë¤ ìˆ«ìë¥¼ ë³´ëƒ„
    
- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ API
    
    ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°›ì•„ì˜´ â†’ ì¿ í‚¤ì˜ ëœë¤ ìˆ«ìì™€ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ìˆëŠ” ëœë¤ ìˆ«ìë¥¼ í†µí•´ í•´ë‹¹ ì•„ì´ë””ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½
    
- í’€ì´
    
    flagì—ì„œ Postë¡œ ì•„ë˜ì˜ ì½”ë“œë¥¼ ë³´ë‚´ë©´
    
    ```c
    <img src= /change_password?pw=1234>
    ```
    
    flagì—ì„œ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ëœë¤ ìˆ«ìì™€ adminì„ì„ ë°œê¸‰í•˜ê³  ëœë¤ ìˆ«ìë¥¼ ì¿ í‚¤ì— ë„£ì–´ì„œ ìœ„ì˜ ì½”ë“œë¥¼ ë³´ë‚¸ë‹¤
    
    vulnì—ì„œ í•„í„°ë§ ì´í›„ í•´ë‹¹ ì½”ë“œë¥¼ ìˆ˜í–‰í•œë‹¤. 
    
    ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ë•Œ ëœë¤ ìˆ«ìë¥¼ í†µí•´ adminì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ê³  adminìœ¼ë¡œ ë¡œê·¸ì¸ í•˜ë©´ í•´ê²°!